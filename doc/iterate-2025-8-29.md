# dbsyncer 2025-8-29 需求

## 性能优化

偏移量更新不使用 spring 事件机制（onApplicationEvent, 有同步堵塞问题），现象运行过程中界面响应超慢。

## 不成熟的想法

- 减少查找：
  - fullPuller 挂载了 Task
  - incrementPuller 挂载了 meta 与 listener 的关系 

方法，结构调整：使数据挂载服务，而不是服务挂载数据。

## 实施方法

当前实现分析

1. 当前事件处理流程
   
   1. 在 GeneralBufferActuator.pull() 方法中处理 ROW 和 DDL 类型事件后，会发布 RefreshOffsetEvent 事件：
      
      - ROW 类型事件处理后直接发布事件      
      - DDL 类型事件处理后也会发布事件
   
   2. IncrementPuller 监听 RefreshOffsetEvent 事件，并通过以下方式处理：
      
      - 通过 metaId 获取 Meta 对象      
      - 从 Meta 对象获取 Listener      
      - 调用 Listener.refreshEvent() 方法更新偏移量

2. 当前实现存在的问题
   
   1. 性能问题：
      
      - 使用 Spring 事件机制增加了额外的开销      
      - 需要通过 metaId 多次查找对象（先找 Meta，再找 Listener）
   
   2. 耦合度问题：
      
      - GeneralBufferActuator 依赖于 Spring 的 ApplicationContext 来发布事件      
      - IncrementPuller 需要监听事件并进行对象查找

建议改进方案评估

方案：将 refreshEvent 调用直接集成到 BufferActuatorRouter 中

价值评估

1. 性能提升：
   
   - 避免使用 Spring 事件机制，减少中间环节   
   - 可以直接通过 router 缓存获取对应的执行器，减少对象查找时间   
   - 减少线程间通信开销

2. 架构优化：
   
   - 降低模块间的耦合度，GeneralBufferActuator 不再需要依赖 ApplicationContext   
   - 将事件处理逻辑集中到 BufferActuatorRouter 中，提高代码内聚性

3. 可维护性提升：
   
   - 事件处理逻辑集中，便于维护和调试   
   - 减少跨模块依赖，提高代码清晰度

风险评估

1. 改动范围：
   
   - 需要修改 GeneralBufferActuator 类，移除事件发布逻辑
   - 需要修改 BufferActuatorRouter 类，增加 refreshOffset 方法
   - 需要调整 IncrementPuller 中的事件监听逻辑
   - 

2. 兼容性风险：
   
   - 需确保新的实现方式与所有类型的 Listener 兼容
   - 需确保 TableGroupBufferActuator（继承自 GeneralBufferActuator）也能正常工作

3. 潜在问题：
   
   - 如果 router 中没有对应的 metaId，需要有备选方案
   - 需要考虑线程安全问题，因为 router 是 ConcurrentHashMap

实施建议

1. 渐进式改进：
   
   - 先在 BufferActuatorRouter 中添加新的 refreshOffset 方法
   - 修改 GeneralBufferActuator 调用新的方法而不是发布事件
   - 保留 IncrementPuller 的事件监听逻辑作为备选方案

2. 异常处理：
   
   - 需要处理 router 中找不到对应 metaId 的情况
   - 需要考虑 Listener 为 null 的情况

其他：全面测试